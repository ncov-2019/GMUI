<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRC歌词格式转换工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", Arial, sans-serif;
        }

        body {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f7fa;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 25px;
            font-size: 24px;
            text-align: center;
            font-weight: 600;
        }

        .input-area,
        .output-area {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
        }

        #inputLrc {
            min-height: 200px;
        }

        #outputResult {
            min-height: 150px;
            background-color: #fafafa;
            cursor: text;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        #convertBtn {
            background-color: #409eff;
            color: white;
        }

        #convertBtn:hover {
            background-color: #337ecc;
        }

        #copyBtn {
            background-color: #67c23a;
            color: white;
        }

        #copyBtn:hover {
            background-color: #52af3a;
        }

        #clearBtn {
            background-color: #909399;
            color: white;
        }

        #clearBtn:hover {
            background-color: #7d8086;
        }

        #urlBtn {
            background-color: #ff6e49;
            color: white;
            border: none;
            cursor: pointer;
        }

        #urlBtn:hover {
            background-color: #da5938;
        }

        .tip {
            color: #909399;
            font-size: 12px;
            margin-top: 8px;
            line-height: 1.5;
        }

        .success-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f0f9ff;
            color: #67c23a;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 999;
            transition: opacity 0.3s;
        }

        .word-count-info {
            margin-top: 8px;
            padding: 8px;
            background-color: #f5fafe;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>LRC歌词格式转换工具</h1>

        <div class="input-area">
            <label for="inputLrc">请输入LRC格式歌词：</label>
            <textarea id="inputLrc" placeholder="[00:00.00] XXX XXX XXX"></textarea>
        </div>

        <div class="btn-group">
            <button id="convertBtn">转换格式</button>
            <button id="copyBtn">复制结果</button>
            <button id="clearBtn">清空内容</button>
            <button id="urlBtn"
                onclick="if(confirm('将跳转至歌词库网站\n/xiaojiangclub.com')) { window.open('https:/xiaojiangclub.com/') }">♿</button>
        </div>

        <div class="output-area">
            <label for="outputResult">转换结果：</label>
            <textarea id="outputResult" placeholder="转换后的结果将显示在这里..."></textarea>
            <div class="word-count-info" id="wordCountInfo"></div>
        </div>

        <div class="tip">
            格式说明：<br>
            1. 自动去除每行歌词首尾空格<br>
            2. 换行符替换为^符号<br>
            3. 开头添加[music:]前缀<br>
            4. 歌词内容（不含时间戳）字数限制：中文≤20字，英文/符号≤40字，超出自动插入&lt;br&gt;<br>
            5. 优先在最后一个空格处拆分，无空格则在超出字数-5字的位置插入&lt;br&gt;
        </div>
    </div>

    <div class="success-alert" id="successAlert">复制成功！</div>

    <script>
        // DOM元素
        const inputLrc = document.getElementById('inputLrc');
        const outputResult = document.getElementById('outputResult');
        const convertBtn = document.getElementById('convertBtn');
        const copyBtn = document.getElementById('copyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const successAlert = document.getElementById('successAlert');
        const wordCountInfo = document.getElementById('wordCountInfo');

        // 初始化事件监听
        function init() {
            convertBtn.addEventListener('click', convertLrc);
            copyBtn.addEventListener('click', copyResult);
            clearBtn.addEventListener('click', clearAll);
        }

        // 核心转换函数
        function convertLrc() {
            // 获取输入内容并去除首尾空白
            const lrcText = inputLrc.value.trim();
            if (!lrcText) {
                outputResult.value = '';
                wordCountInfo.style.display = 'none';
                alert('请输入LRC格式歌词！');
                return;
            }

            // 按行分割
            const lines = lrcText.split(/\r?\n/).filter(line => line.trim() !== '');
            const processedLines = [];
            const wordCountDetails = [];

            // 处理每一行
            lines.forEach((line, index) => {
                // 匹配LRC时间戳格式 [xx:xx.xxx] 兼容[xx:xx]格式
                const timeStampRegex = /^\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/;
                const timeStampMatch = line.match(timeStampRegex);

                if (timeStampMatch) {
                    // 提取时间戳和歌词内容
                    const timeStamp = timeStampMatch[0];
                    let lyric = line.replace(timeStampRegex, '').trim(); // 去除时间戳和首尾空格

                    // 记录字数信息
                    const charCount = lyric.length;
                    // 判断是否为中文内容（只要包含中文就按中文规则）
                    const hasChinese = /[\u4e00-\u9fa5]/.test(lyric);
                    const maxLength = hasChinese ? 20 : 40;
                    wordCountDetails.push(`第${index + 1}行："${lyric}" (字数：${charCount}/${maxLength})${charCount > maxLength ? ' → 已拆分' : ''}`);

                    // 检查是否需要拆分
                    if (charCount > maxLength) {
                        lyric = splitLyric(lyric, maxLength);
                    }

                    // 拼接处理后的行
                    processedLines.push(`${timeStamp}${lyric}`);
                } else {
                    // 非标准LRC行直接保留（去除首尾空格）
                    processedLines.push(line.trim());
                }
            });

            // 拼接最终结果：添加前缀 + 替换换行符为^
            const finalResult = `[music:]${processedLines.join('^')}`;

            // 显示结果和字数信息
            outputResult.value = finalResult;
            wordCountInfo.textContent = wordCountDetails.join('\n');
            wordCountInfo.style.display = 'block';
        }

        // 拆分超长歌词 - 修复核心逻辑
        function splitLyric(lyric, maxLength) {
            // 1. 优先在maxLength范围内找最后一个空格拆分（更合理的拆分位置）
            const spaceIndexes = [];
            // 收集maxLength范围内的所有空格位置
            for (let i = 0; i < Math.min(lyric.length, maxLength); i++) {
                if (lyric[i] === ' ') {
                    spaceIndexes.push(i);
                }
            }

            // 如果有空格，取最后一个空格位置拆分
            if (spaceIndexes.length > 0) {
                const lastSpacePos = spaceIndexes[spaceIndexes.length - 1];
                return lyric.substring(0, lastSpacePos) + '<br>' + lyric.substring(lastSpacePos + 1);
            }

            // 2. 无空格则在 超出字数-5 位置拆分（修正计算逻辑）
            const splitPos = maxLength - 5;
            // 确保拆分位置有效
            const validSplitPos = Math.max(1, Math.min(splitPos, lyric.length - 1));
            return lyric.substring(0, validSplitPos) + '<br>' + lyric.substring(validSplitPos);
        }

        // 复制结果到剪贴板
        function copyResult() {
            const result = outputResult.value;
            if (!result) {
                alert('暂无可复制的内容！');
                return;
            }

            // 复制到剪贴板
            navigator.clipboard.writeText(result).then(() => {
                // 显示成功提示
                successAlert.style.display = 'block';
                successAlert.style.opacity = '1';

                // 3秒后隐藏提示
                setTimeout(() => {
                    successAlert.style.opacity = '0';
                    setTimeout(() => {
                        successAlert.style.display = 'none';
                    }, 300);
                }, 3000);
            }).catch(err => {
                // 降级复制方案
                outputResult.select();
                document.execCommand('copy');
                alert('复制成功！');
            });
        }

        // 清空所有内容
        function clearAll() {
            inputLrc.value = '';
            outputResult.value = '';
            wordCountInfo.style.display = 'none';
            wordCountInfo.textContent = '';
        }

        // 初始化
        init();
    </script>
</body>

</html>